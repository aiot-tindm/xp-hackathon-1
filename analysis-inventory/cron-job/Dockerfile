# Dockerfile cho Cron Job Service
# Cháº¡y analysis.py hÃ ng ngÃ y Ä‘á»ƒ phÃ¢n tÃ­ch dá»¯ liá»‡u

FROM python:3.11-slim

# Thiáº¿t láº­p metadata
LABEL maintainer="Analytics Team"
LABEL description="Docker container cho Cron Job Service - cháº¡y analysis.py hÃ ng ngÃ y"

# Thiáº¿t láº­p working directory
WORKDIR /app

# CÃ i Ä‘áº·t system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    cron \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY ../requirements.txt .

# CÃ i Ä‘áº·t Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy toÃ n bá»™ source code
COPY ../package ./package
COPY ../cron-job ./cron-job

# Táº¡o thÆ° má»¥c logs
RUN mkdir -p /app/logs

# Thiáº¿t láº­p environment variables
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# Táº¡o script cháº¡y analysis vá»›i retry logic
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Khá»Ÿi Ä‘á»™ng Analysis System..."\n\
echo "ðŸ“Š Cháº¡y analysis.py..."\n\
\n\
# Retry logic cho MySQL connection\n\
max_attempts=30\n\
attempt=1\n\
\n\
while [ $attempt -le $max_attempts ]; do\n\
    echo "   Thá»­ káº¿t ná»‘i MySQL láº§n $attempt/$max_attempts..."\n\
    \n\
    cd /app/cron-job\n\
    if python analysis.py; then\n\
        echo "âœ… HoÃ n thÃ nh phÃ¢n tÃ­ch!"\n\
        exit 0\n\
    else\n\
        echo "   Lá»—i káº¿t ná»‘i MySQL, thá»­ láº¡i sau 2 giÃ¢y..."\n\
        sleep 2\n\
        attempt=$((attempt + 1))\n\
    fi\n\
done\n\
\n\
echo "âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i MySQL sau $max_attempts láº§n thá»­!"\n\
exit 1\n\
' > /app/run_analysis.sh && chmod +x /app/run_analysis.sh

# Táº¡o script Ä‘á»ƒ trigger analysis tá»« bÃªn ngoÃ i
RUN echo '#!/bin/bash\n\
echo "ðŸ”§ Manual trigger analysis..."\n\
/app/run_analysis.sh\n\
' > /app/trigger_analysis.sh && chmod +x /app/trigger_analysis.sh

# Táº¡o script entrypoint vá»›i cron
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Khá»Ÿi Ä‘á»™ng Cron Job Service..."\n\
echo "ðŸ“… Thiáº¿t láº­p cron job cháº¡y hÃ ng ngÃ y lÃºc 11:30 PM (23:30)..."\n\
echo "ðŸ”§ CÃ³ thá»ƒ trigger analysis thá»§ cÃ´ng báº±ng lá»‡nh: docker exec analytics_cron_job /app/trigger_analysis.sh"\n\
\n\
# ThÃªm cron job\n\
echo "30 23 * * * /app/run_analysis.sh >> /app/logs/cron.log 2>&1" > /etc/cron.d/analysis-cron\n\
chmod 0644 /etc/cron.d/analysis-cron\n\
crontab /etc/cron.d/analysis-cron\n\
\n\
# Cháº¡y analysis láº§n Ä‘áº§u\n\
echo "ðŸ” Cháº¡y phÃ¢n tÃ­ch láº§n Ä‘áº§u..."\n\
/app/run_analysis.sh\n\
\n\
echo "â° Cron job Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p. Sáº½ cháº¡y hÃ ng ngÃ y lÃºc 11:30 PM (23:30)."\n\
echo "ðŸ”§ Äá»ƒ cháº¡y analysis ngay láº­p tá»©c, sá»­ dá»¥ng:"\n\
echo "   docker exec analytics_cron_job /app/trigger_analysis.sh"\n\
echo "ðŸ“‹ Logs sáº½ Ä‘Æ°á»£c lÆ°u táº¡i /app/logs/cron.log"\n\
\n\
# Khá»Ÿi Ä‘á»™ng cron daemon\n\
cron -f\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Thiáº¿t láº­p entrypoint
ENTRYPOINT ["/app/entrypoint.sh"] 